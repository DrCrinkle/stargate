# appimage-builder recipe see https://appimage-builder.readthedocs.io for details
version: 1
script:
  - cd /stargate
  - rm -rf AppDir  | true
  - mkdir AppDir
  - cd /root/Python-3.10.8
  - './configure --enable-optimizations --prefix=/usr && DESTDIR=/stargate/AppDir make install'
  - cd /stargate
  - ln -s python3 AppDir/usr/bin/python
  - 'python3.10 -m pip install --ignore-installed --prefix=/usr --root=AppDir -r ./requirements.txt PyQt6==6.2.3 numpy'
  - make clean
  - PORTMIDI_FLAG='-l:libportmidi.so' make
  - DESTDIR=AppDir make install
  - sed -i 's!Icon=stargate!Icon=usr/share/pixmaps/stargate.png!g' AppDir/usr/share/applications/stargate.desktop
  - "mkdir -p AppDir/bin && cp /bin/sh AppDir/bin/sh"
  - cp /usr/bin/env AppDir/usr/bin/
  - 'cd /root/libsndfile-1.1.0/ && DESTDIR=/stargate/AppDir make install'
  - 'cd /root/portaudio-19.7.0/ && DESTDIR=/stargate/AppDir make install'
  - 'cd /root/portmidi-2.0.4/ && DESTDIR=/stargate/AppDir make install'
  - apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32
  #- ln -s libportmidi.so.2 /stargate/AppDir/usr/lib/x86_64-linux-gnu/libportmidi.so.0
AppDir:
  path: /stargate/AppDir
  app_info:
    id: com.github.stargatedaw.stargate
    name: StargateDAW
    icon: stargate
    version: {{VERSION}}
    exec: usr/bin/python3
    exec_args: "$APPDIR/usr/bin/stargate $@"
  apt:
    arch: ['amd64']
    allow_unauthenticated: true
    sources:
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic main restricted
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic-updates main restricted
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic universe
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic-updates universe
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic multiverse
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic-updates multiverse
    - sourceline: deb http://archive.ubuntu.com/ubuntu/ bionic-backports main restricted
        universe multiverse
    - sourceline: deb http://security.ubuntu.com/ubuntu/ bionic-security main restricted
    - sourceline: deb http://security.ubuntu.com/ubuntu/ bionic-security universe
    - sourceline: deb http://security.ubuntu.com/ubuntu/ bionic-security multiverse
    include:
      - libasound2
      - libbz2-1.0
      - libffi6
      - libfftw3-3
      - libjack-jackd2-0
      - rubberband-cli
      - libflac8
      - libogg0
      - libmp3lame0
      - libmpg123-0
      - libopus0
      - libvorbis0a
      - libx11-xcb1
      - libx11-6
      - libfontconfig1
      - libwayland-client0
      - libwayland-egl1
      - libxext6
      - libxfixes3
      - libxi6
      - libxrender1
      - libxcb1
      - libxcb-dri2-0
      - libxcb-dri3-0
      - libxcb-glx0
      - libxcb-keysyms1
      - libxcb-image0
      - libxcb-shm0
      - libxcb-icccm4
      - libxcb-xfixes0
      - libxcb-shape0
      - libxcb-randr0
      - libxcb-render-util0
      - vorbis-tools
  runtime:
    env:
      PYTHONHOME: '${APPDIR}/usr/lib/python3.10'
      PYTHONPATH: '${APPDIR}/usr/lib/python3.10:${APPDIR}/usr/lib/python3.10/site-packages:${APPDIR}/usr/lib/python3.10/lib-dynload'
  files:
    include: []
    exclude:
    - usr/share/man
    - usr/share/doc/*/README.*
    - usr/share/doc/*/changelog.*
    - usr/share/doc/*/NEWS.*
    - usr/share/doc/*/TODO.*
AppImage:
  arch: x86_64
  update-information: guess
